<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Wrapping Native Libraries with C#</title>
  <meta name="description" content="This guide demonstrates how to wrap a C/C++ library in order to call into it from .NET.  Using C#">

  <!-- OpenGraph for Facebook, Twitter, Slack unfurling -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/guides/rhinocommon/wrapping-native-libraries/" />
  <meta property="og:title" content="Wrapping Native Libraries" />
  <meta property="og:description" content="This guide demonstrates how to wrap a C/C++ library in order to call into it from .NET." />
  <meta property=”og:site_name” content="developer.rhino3d.com"/>
  <meta property=”og:image” content="http://developer.rhino3d.com/images/rhinodev-logo-unfurl.png"/>

  <!-- twitter card tags additive with the og: tags -->
  <meta name="twitter:domain" value="developer.rhino3d.com" />
  <meta name="twitter:title" value="Wrapping Native Libraries" />
  <meta name="twitter:description" value="This guide demonstrates how to wrap a C/C++ library in order to call into it from .NET." />
  
    <meta name="twitter:image" content="http://developer.rhino3d.com/images/rhinodev-logo-unfurl.png" />
  
  <meta name="twitter:url" value="http://developer.rhino3d.com" />
  
  <meta name="twitter:label1" value="Platform(s)" />
  <meta name="twitter:data1" value="Windows, Mac" />
  
  
  <meta name="twitter:label2" value="Language(s)" />
  <meta name="twitter:data2" value="C#" />
  

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/vbnet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="/node_modules/highlightjs-line-numbers.js/dist/highlightjs-line-numbers.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script>hljs.initLineNumbersOnLoad();</script>

  <!-- Overridden theme -->
  <link rel="stylesheet" href="/css/main.css">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- Optional theme -->
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous"> -->
  <!-- Bootstrap override -->
  <link rel="stylesheet" href="/css/bootstrap-override.css">

  <link rel="canonical" href="http://developer.rhino3d.com/guides/rhinocommon/wrapping-native-libraries/">
  <link rel="alternate" type="application/rss+xml" title="Rhino Developer Docs" href="http://developer.rhino3d.com/feed.xml" />

  <link rel="shortcut icon" href="https://developer.rhino3d.com/favicon.ico?v=2" />
  <!-- Saving bookmarks to mobile devices -->
  <!-- For non-Retina (@1× display) iPhone, iPod Touch, and Android 2.1+ devices: -->
  <link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png"><!-- 57×57px -->
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/apple-touch-icon-76x76-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/apple-touch-icon-120x120-precomposed.png">
  <!-- For iPad with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">
  <!-- For iPad with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/apple-touch-icon-152x152-precomposed.png">
  <!-- For iPhone 6 Plus with @3× display: -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/images/apple-touch-icon-180x180-precomposed.png">
  <!-- For Chrome for Android: -->
  <link rel="icon" sizes="192x192" href="/images/touch-icon-192x192.png">

  <!-- Enable crawling because this version is the stable version -->
  <!--<meta name="robots" content="noindex" />-->
</head>


  <body>

    <!-- Google Tag Manager **This belongs right after the <body> tag**-->
    <noscript>
        <iframe src="//www.googletagmanager.com/ns.html?id=GTM-MWMDKN"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MWMDKN');
    </script>
    <!-- End Google Tag Manager -->


    

<!-- The following are "casts" from the string to number using math filters... -->



<!-- ...but we need to check to see if the original branches were numbers or not... -->









  <div class="version-banner">

    
      
        
        
          <!-- <strong>NEW:</strong> Welcome to the <strong>Rhino 7</strong> version of this page! <a href="/6/guides/rhinocommon/wrapping-native-libraries/">Looking for the older Rhino 6 version?</a> -->
          Welcome to the <strong>Rhino 7</strong> version of this page!
          <a href="/wip/guides/rhinocommon/wrapping-native-libraries/">Looking for the newer Rhino 8 WIP version?</a>
        
        
      
    
</div>

<!-- Check the version banner for broken links and remove the link if found -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!-- <script>
$(document).ready(function()
{
  var splitPath = window.location.pathname.split("/");
  var linkURL = "/" + splitPath.splice(2,splitPath.length-2).join("/");

  $.get(linkURL).fail(function ()
  {
    var $aTag = $("div.version-banner > a");
    $aTag.text("View the current site instead.");
    $aTag.attr("href", "/");
  });
});
</script> -->


    <div class="container">

      <header class="site-header">


    <a class="site-title" href="/"><img src="/images/rhinodevlogo148x128.png" alt="Rhino Developer Docs" height="48" width="56"></a><a class="site-title" href="/">Rhino Developer Docs</a>

    <nav class="site-nav">
      <img class="menu-icon" src="/images/gi.svg">
      
      <div class="trigger">
      	<!--<a class="page-link" href="/">Welcome</a>-->
        <!-- get current page title and "collection" to figure out which nav
             link should be "active" -->
        
        
        
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
            
              
                
              
            
          
        
          
        
          
            
              
            
          
        
          
            
              
                
                  
                    <a class="page-link active" href="/guides/">Guides</a>
                    
                  
              
            
          
        
          
            
              
                
                  
                    <a class="page-link" href="/api/">API</a>
                    
                  
              
            
          
        
          
            
              
                
                  
                    <a class="page-link" href="/samples/">Samples</a>
                    
                  
              
            
          
        
          
            
          
        
          
            
              
                
                  
                    <a class="page-link" href="/videos/">Videos</a>
                    
                  
              
            
          
        
        <a class="page-link" href="https://discourse.mcneel.com/c/rhino-developer">Forums</a>
        <!-- Google Search Engine -->
        <!-- TODO Move to this site back into the Mcneel search, or use a simple site only search for results -->
        <div id="sitesearch">
            <!-- CSE Search Box Begins  -->
            <form id="search-box" name="search-box" onsubmit="sitesearchFunction()" action="/search-results.html">
                <input id="searchtext" type="search" name="q" size="24" value="" placeholder="Search" />
                <input class="searchBox" type="submit" size="2" value=" " />
            </form>
			<script type="text/javascript">
			function sitesearchFunction(){
				var form_id = document.getElementById("search-box");
				var form_action = form_id.action;
                var form_sb = document.getElementById("searchtext");
				var query_src = form_sb.value + " site:developer.rhino3d.com";
				form_sb.value = query_src.toString();
			}
			</script>
<!-- Google CSE Search Box Ends -->
        </div>
        <!--End of Google Search Engine -->
      </div>
    </nav>

</header>


      <div class="page-content">
        <!--div class="wrapper"-->
          <div class="container-fluid">

<div class="row-fluid">
    <!--Nav Bar -->
    <nav class="col-xs-0 col-md-3 bs-docs-sidebar">
    <ul id="sidebar" class="nav nav-stacked fixed">
        <!-- Find the h2 group and any h3 subgroups -->
        

        
          

          
            
            
            
            
            <li>
              <a href="#overview">Overview</a>

              
                <ul class="nav nav-stacked">
                  

                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#prerequisites">Prerequisites</a>
                    </li>
                  

                </ul>
              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#samplelibrary">SampleLibrary</a>

              
                <ul class="nav nav-stacked">
                  

                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#windows">Windows</a>
                    </li>
                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#mac">Mac</a>
                    </li>
                  

                </ul>
              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#samplenativelibrary">SampleNativeLibrary</a>

              
                <ul class="nav nav-stacked">
                  

                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#windows-1">Windows</a>
                    </li>
                  
                    
                    
                    
                    
                    
                    <li>
                        <a href="#mac-1">Mac</a>
                    </li>
                  

                </ul>
              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#next-steps">Next Steps</a>

              

            </li>
          

        
          

          
            
            
            
            
            <li>
              <a href="#related-topics">Related topics</a>

              

            </li>
          

        
    </ul>
</nav>


    <!--Main Content -->
    <div class="col-xs-12 col-md-9">
      <!--<div class="post">-->

        <article class="post-content">

          <ol class="breadcrumb">
              
              
              
              
              <li><a href="/guides/rhinocommon">RhinoCommon</a></li>

              
                
                  <li class="active">Advanced</li>
                
              
          </ol>

          <h1>Wrapping Native Libraries</h1>

          <p>
  <span class="guide_byline">
    
      
      by <a href="/authors/dan_rigdon_bel">Dan Rigdon-Bel</a> (Last modified: <a href="https://github.com/mcneel/developer-rhino3d-com/commits/7/_guide_topics/rhinocommon/wrapping-native-libraries.md" target="_blank">03 Sep 2021</a>)
    
  </span>

</p>

          <p>This guide demonstrates how to wrap a C/C++ library in order to call into it from .NET.</p>

          <h2 id="overview">Overview</h2>

<p>We present a sample solution that uses Platform Invoke (PInvoke), which allows .NET code to call functions that are implemented in a C/C++ DLL (Windows) or dylib (macOS).  It is important to understand that the main utility of this advanced approach is in the ability to call the same C/C++ code on both platforms from .NET.</p>

<p>First, we will build a simple C/C++ library that adds two numbers together.  After that, we will examine the wrapping .NET code required to call into our library from a RhinoCommon plugin on both Windows and Mac.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>This guide does not presume you are a C/C++ or .NET expert, but assumes you have a functional working knowledge of both.  This is an advanced guide; that said, the intent of this guide is to illustrate basic considerations of wrapping a C/C++ library and the logistical issues calling it from a RhinoCommon plugin on both Windows and Mac.</p>

<p>We will be analyzing a sample solution called <em><a href="https://github.com/dalefugier/SampleNativeLibrary">SampleNativeLibrary</a></em>.  Please clone or download this repository.  <em>SampleNativeLibrary</em> builds against the RhinoWIP (on Windows) and Rhino 5 for Mac (on macOS).  (On Windows, it is possible to use Rhino 6, but you will have to change the RhinoCommon references).</p>

<p>It is presumed you already have <em>all</em> the necessary tools installed and are ready to go.  If you are not there yet, see both <a href="/guides/rhinocommon/installing-tools-windows">Installing Tools (Windows)</a> and <a href="/guides/rhinocommon/installing-tools-mac">Installing Tools (Mac)</a>.  It is also helpful to have read and understood <a href="/guides/rhinocommon/your-first-plugin-crossplatform">Your First Plugin (Cross-Platform)</a>.</p>

<div class="bs-callout bs-callout-danger">
  <h4>WARNING</h4>
  <p>Other methods to create a .NET binding to a C# library exist. A notorious one is based on the compilation of the C++ library with the C++/CLI compiler. To keep things compatible with the Apple macOS, and because the IJW (it just works) technology sometimes does not, we suggest the use of PInvoke.</p>
</div>

<h2 id="samplelibrary">SampleLibrary</h2>

<p>Let’s begin by taking a look at an absurdly simple C/C++ “library” - SampleLibrary - that does one thing: add two numbers together.  We’ll start on Windows, but it really doesn’t matter if you start on a macOS, nearly everything that follows applies on each platform…</p>

<h3 id="windows">Windows</h3>

<ol>
  <li>Open <em>SampleNativeLibrary.sln</em> in <em>Visual Studio</em>.</li>
  <li>In the Solution Explorer, you will notice there are three projects…two C# (.csproj) projects and one C++ project.  Expand the <em>SampleLibrary</em> C++ project…
<img src="/images/wrapping-native-libraries-02.png" alt="SampleNativeLibrary" /></li>
  <li>The <em>SampleLibrary</em> (.vcxproj) is just a boilerplate C++ project (created using the regular Shared MFC C++ project wizard) that was created by Visual Studio.  <em>There is nothing fancy going on here at all; much of the code is not even relevant to this guide</em>.</li>
  <li>
    <p>Open the <em>SampleLibrary.cpp</em> file and take a look.  Nearly all of the code in this file is auto-generated boilerplate.  The only important section to pay attention to is:</p>

    <pre><code> SAMPLELIBRARY_C_FUNCTION
 double Add(int a, double b)
 {
   return a + b;
 }  
</code></pre>

    <p>…even if you are not a C/C++ programmer, this C function should be clear to you.  <code>Add</code> takes a native <code>int</code> and a native <code>double</code>, and returns the sum of the inputs as a native <code>double</code>.  Take note of the <code>SAMPLELIBRARY_C_FUNCTION</code> decoration above the implementation…we will talk about that in a moment.</p>
  </li>
  <li>In the <em>Header Files</em> filter, find and open the <em>SampleLibraryInclude.h</em> header file.  The first thing to note is that there are two well <code>#defined</code> sections to this header: one that relates to Windows (<code>#if defined (_WIN32)</code>) and one that relates to Mac (<code>#if defined(__APPLE__)</code>).  The code in these #defines are basically telling the linker to export functions in a specific way.  The reason they are different on each platform is that Dynamic Link Libraries (DLLs) are implemented differently in Windows and macOS - each platform has a unique way of telling the linker what to do with the library.  How this works is not really important at this juncture, just know that these MACROs tell the linker to export the functions.  More importantly…</li>
  <li>
    <p>Take a look at the function declaration at the bottom of the file:</p>

    <pre><code> SAMPLELIBRARY_C_FUNCTION
 double Add(int a, double b);
</code></pre>

    <p>…is decorated with the same <code>SAMPLELIBRARY_C_FUNCTION</code>.</p>
  </li>
  <li>This is the decoration that tells the linker to make the function available to outside callers.  By decorating with this macro, the linker adds information to the DLL that makes these functions public.  Without this decoration, these functions would not be available outside the the assembly (.dll or .dylib).  By providing this decoration, we are doing the .NET equivalent of making them “public”.</li>
  <li>Do a “sanity check” and <em>Build</em> SampleLibrary to make sure that all your tools are working as expected.  SampleLibrary should build without errors as the native <em>SampleLibrary.dll</em> in the project <em>/bin</em> folder.  Ok, now that we know roughly what is in the native SampleLibrary on Windows, let’s take a look at it on macOS…</li>
</ol>

<h3 id="mac">Mac</h3>

<ol>
  <li>Launch <em>Xcode</em> and open <em>SampleLibrary.xcodeproj</em>.  (Unlike Visual Studio on Windows, on macOS, we cannot do all of our development in a single IDE, but we have to build our native C/C++ <em>SampleLibrary</em> using the native Apple Tools - Xcode and xcodebuild).</li>
  <li>In the <em>Project Navigator</em>, notice that this project is referencing the <em>exact same source code</em> as its Windows counterpart…
<img src="/images/wrapping-native-libraries-03.png" alt="SampleLibrary on macOS" /></li>
  <li>Instead of building a .dll, on macOS we are building <em>libSampleLibrary.dylib</em> which - despite the extension - amounts to exactly the same thing as a dll.  For all intents and purposes, SampleLibrary does exactly the same thing on macOS that it does on Windows and the source is the same.</li>
  <li><em>Build</em> SampleLibrary using Xcode to make sure that it builds successfully.</li>
  <li><em>Quit</em> Xcode.  On macOS, we are actually going to use command line <code>xcodebuild</code> from Visual Studio for Mac to build our native library, but we’ll talk about that below.</li>
</ol>

<p>Now that we have examined the simple native SampleLibrary, let’s turn our attention to the .NET portion of our wrapping code…</p>

<h2 id="samplenativelibrary">SampleNativeLibrary</h2>

<p>SampleNativeLibrary is the .NET project that calls into the SampleLibrary.  On each platform, we are using the exact same wrapping source code, just using cloned .csproj projects on each platform.  (For more information on this cross-platform strategy, see the <a href="/guides/rhinocommon/your-first-plugin-crossplatform">Your First Plugin (Cross-Platform)</a> guide).</p>

<p>Let’s take a look at SampleNativeLibrary on Windows using Visual Studio first…</p>

<h3 id="windows-1">Windows</h3>

<ol>
  <li>If you have not done so already, open the <em>SampleNativeLibrary.sln</em> in <em>Visual Studio</em>.</li>
  <li>If you have not done so already, build <em>SampleLibrary</em>.  Verify that <em>SampleLibrary.dll</em> is present in your <em>/bin</em> folder.</li>
  <li>Now, let’s turn our attention to the <em>SampleRhino.Win</em> project.  Make sure that <em>SampleRhino.Win</em> is set as the Startup Project and expand it so you can see the source files…
<img src="/images/wrapping-native-libraries-04.png" alt="SampleRhino on Windows" /></li>
  <li>Before we do anything, let’s build and test the plugin.  Build <em>SampleRhino.Win</em>.</li>
  <li>Load the <em>SampleRhino.rhp</em> in Rhino and run the <em>SampleRhinoCommand</em>.  You will be prompted to enter two numbers.  Once you have done that you should see the result in a dialog box…
<img src="/images/wrapping-native-libraries-05.png" alt="SampleRhino plugin test" /></li>
  <li>The “additional” calculation for this command was all performed in the native C/C++ SampleLibrary.dll.  Return to <em>Visual Studio</em>.  Let’s take a look at how the <code>Add</code> function is being called.</li>
  <li>
    <p>Open <em>SampleRhinoCommand.cs</em> and find the <code>RunCommand</code> method.  After prompting the user to enter two numbers, we see the following code</p>

    <pre><code> var result = RhinoMath.UnsetValue;
 try
 {
   result = UnsafeNativeMethods.Add(first, second);
 }
 catch (Exception ex)
 {
   RhinoApp.WriteLine(ex.Message);        
   return Result.Failure;
 }
</code></pre>
  </li>
  <li>The <code>Add(first, second)</code> method is being called on the <code>UnsafeNativeMethods</code> class.  Open <em>UnsafeNativeMethods.cs</em>.  Let’s go through this class line-by-line.</li>
  <li>The necessary functionality to use PInvoke is contained in the <code>System.Runtime.InteropServices</code> namespace, specifically the <code>DllImport</code> function.</li>
  <li>
    <p><em>UnsafeNativeMethods.cs</em> contains the class:</p>

    <pre><code> internal static class Import
 {
   public const string lib = "SampleLibrary.dll";
 }
</code></pre>

    <p>…which declares a <code>lib</code> string member.  On Windows, it is necessary to explicitly state the name of the native dll being called (on macOS, a <em>.dll.config</em> file is used to point to a .dylib - see below).</p>
  </li>
  <li>
    <p>The <code>UnsafeNativeMethods</code> class itself contains a single function…</p>

    <pre><code> internal static extern double Add(int a, double b);
</code></pre>

    <p>…does this look familiar?</p>
  </li>
  <li>
    <p>The <code>Add</code> function is decorated with an <a href="https://msdn.microsoft.com/en-us/library/z0w1kczw.aspx">Attribute</a>:</p>

    <pre><code> [DllImport(Import.lib, CallingConvention = CallingConvention.Cdecl)]
</code></pre>

    <p>…this important bit of metadata tells the runtime to look in the native library and call the associated function with a specific language (C) calling convention when the <code>Add</code> method is called from .NET.  <em>This is the point at which the link between the managed .NET code and the unmanaged C/C++ code is established.</em></p>
  </li>
  <li>Since we are bridging the world of managed and unmanaged code, <em>we need to be very careful about the types of variables we are using</em>.  To illustrate this point, let’s change the code and see what happens…</li>
  <li>
    <p>In <em>UnsafeNativeMethods</em> change the function declaration of <code>Add</code> to accept <code>double</code>s (instead of <code>int</code>s) as the first argument…</p>

    <pre><code> internal static extern double Add(double a, double b);
</code></pre>
  </li>
  <li><em>Build</em> the plugin.  No errors or warnings, right?   Now run the plugin and test the <em>SampleRhinoCommand</em> with this change.  Try adding 2 + 2.  What happens?  <em>2 + 2 no longer equals 4</em>.  That’s bad (hopefully, Rhino did not crash).  The compiler did not detect the error we introduced.  Change the type of argument <code>a</code> back to an <code>int</code>, rather than a <code>double</code> and save the file.</li>
  <li><em>You must ensure that the function in .NET exactly matches the function declaration in the header file made in the unmanaged code</em> (in this case, in <em>SampleLibraryInclude.h</em>).  Managing these correspondences is challenging with all but the most trivial libraries.  In <a href="/guides/rhinocommon/using-methodgen">Using methodgen</a>, we will discuss a way of generating these function signatures using a utility program we wrote to maintain RhinoCommon.  Before we do that, let’s turn our attention to…</li>
</ol>

<h3 id="mac-1">Mac</h3>

<ol>
  <li>If you have not done so already, open the <em>SampleNativeLibrary.sln</em> in <em>Visual Studio for Mac</em>.</li>
  <li>The native <em>SampleLibrary</em> project cannot be built from Visual Studio for Mac.  As mentioned above, Visual Studio for Mac is a .NET only IDE; it cannot build C/C++ projects like Visual Studio.  (We will work around this limitation in a moment).</li>
  <li>First, let’s turn our attention to the <em>SampleRhino.Mac</em> project.  Make sure that <em>SampleRhino.Mac</em> is set as the Startup Project and expand it so you can see the source files…
<img src="/images/wrapping-native-libraries-06.png" alt="SampleRhino on Mac" /></li>
  <li>Just as with <em>SampleLibrary</em>, <em>SampleRhino</em> is exactly the same source on both platform: the platform-specific <em>.csproj</em> files are referencing exactly the same <em>.cs</em> files.</li>
  <li><em>Build</em>, run, and test <em>SampleRhinoCommand</em> in Rhino for Mac.  Everything should work as expected.  No surprises here…all the code is the same (if you skipped the <a href="#windows-1">Windows section above</a>, read it now; all of it applies on macOS).</li>
  <li>
    <p>There is one critical difference between how the Windows and macOS wrapping works and it has little to do with code.  As we saw above, <em>UnsafeNativeMethods.cs</em> contains the class:</p>

    <pre><code> internal static class Import
 {
   public const string lib = "SampleLibrary.dll";
 }
</code></pre>

    <p>…which declares a <code>lib</code> string member.  On Windows, it was necessary to explicitly state the name of the native dll being called.  On macOS, this works a little differently.  In order to understand what is different, let’s look at how <em>SampleLibrary.dll</em> gets built on macOS…</p>
  </li>
  <li>In the <a href="#mac">SampleLibrary (Mac) section above</a>, we built SampleLibrary using Xcode.  We mentioned in passing that we could build this using <code>xcodebuild</code> command line from Visual Studio for Mac.  Let’s take a look.</li>
  <li>In the <em>Solution Explorer</em>, <em>double-click</em> the name of the <em>SampleRhino.Mac</em> project to bring up the <em>Project Options</em> dialog.  Navigate to the <em>Build</em> &gt; <em>Custom Commands</em> section…
<img src="/images/wrapping-native-libraries-07.png" alt="SampleRhino.Mac Project Options" /></li>
  <li>There are 5 <em>Custom Commands</em>:
    <ol>
      <li><em>Before Build</em>: This before build steps runs a python script called <em>build_native.py</em> that uses <code>xcodebuild</code> to build the <em>SampleLibrary.xcodeproj</em>, which builds <em>libSampleLibrary.dylib</em>.</li>
      <li>
        <p><em>After Build 1</em>: This after build step copies the <em>SampleLibrary.dll.config</em> file from the <em>/SampleLibrary</em> folder to the target folder.  <em>SampleLibrary.dll.config</em> creates a mapping between calls to <em>SampleLibrary.dll</em> and <em>libSampleLibrary.dylib</em>…</p>

        <pre><code> &lt;configuration&gt;
    &lt;dllmap dll=“SampleLibrary.dll” target="libSampleLibrary.dylib" /&gt;
 &lt;/configuration&gt;
</code></pre>

        <p>On macOS, both the <em>.dll.config</em> file and the <em>.dylib</em> must be in the same folder as the calling .NET dll.</p>
      </li>
      <li><em>After Build 2</em>: This after build step copies <em>libSampleLibrary.dylib</em> to the same folder as the calling .NET dll.</li>
      <li><em>After Clean 1</em>: This after build step deletes the <em>libSampleLibrary.dylib</em> when a clean is performed.</li>
      <li><em>After Clean 1</em>: This after build step deletes the <em>SampleLibrary.dll.config</em> when a clean is performed.</li>
    </ol>
  </li>
  <li>When you <em>Build</em> and run <em>SampleRhino.Mac</em> you can watch the build steps in the <em>output</em> (right) side of the <em>Errors</em> panel.  You may notice that <em>build_native.py</em> will only build <em>libSampleLibrary.dylib</em> if it does not find a previous version.  You can overwrite this with the <code>-o   --overwrite</code> command argument if you want to build the native library every time you build the .NET wrapping dll.</li>
</ol>

<hr />

<h2 id="next-steps">Next Steps</h2>

<p>You have seen how a basic C/C++ library can be wrapped and called from .NET in a Rhino Plugin.  You have also seen what can go wrong when a native method’s export declaration is out-of-sync with its .NET counterpart.  <em>Now what?</em></p>

<p>Check out the <a href="/guides/rhinocommon/using-methodgen">Using methodgen</a> guide for instructions on programmatically generating UnsafeNativeMethods export declarations.</p>

<hr />

<h2 id="related-topics">Related topics</h2>

<ul>
  <li><a href="https://msdn.microsoft.com/en-us/library/aa288468(VS.71).aspx">Microsoft Platform Invoke Tutorial on MSDN</a></li>
  <li><a href="http://www.mono-project.com/docs/advanced/pinvoke/">Interop with Native Libraries on mono-project.org</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/z0w1kczw.aspx">Attributes on MSDN</a></li>
  <li><a href="https://github.com/dalefugier/Moose">Moose sample on GitHub</a></li>
  <li><a href="/guides/rhinocommon/your-first-plugin-crossplatform">Your First Plugin (Cross-Platform)</a></li>
  <li><a href="/guides/rhinocommon/using-methodgen">Using methodgen</a></li>
</ul>

        </article>

      <!--</div>-->

    </div>
</div>
</div>

        <!--/div-->
      </div>

      <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">

      
        <div class="row">
          <div class="col-md-4">

            <p class="text">
              
                
                Author: <a href="/authors/dan_rigdon_bel">Dan Rigdon-Bel</a>
              
            </p>
          </div>
          <div class="col-md-4 text-center">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <a href="https://github.com/mcneel/developer-rhino3d-com/blob/7/_guide_topics/rhinocommon/wrapping-native-libraries.md" target="_blank">Edit page on GitHub</a>
          </div>
            <div class="col-md-4">
              <span class="pull-right">
                <span class="glyphicon glyphicon-cog"></span>&nbsp;<a href="/admin">Admin</a>
              </span>
            </div>
        </div>

        <div class="row text-center">
          © 1997 - 2022 Robert McNeel &amp; Associates<br/>
          <span class="glyphicon glyphicon-heart-empty"></span>&nbsp;<a href="/authors">Contributions welcome</a>
        </div>

      

    </div>

  </div>

  <script>
    if (navigator.appVersion.indexOf("Win")!=-1)
    {
      var body = document.getElementsByTagName("body");
      body[0].style.fontWeight = '400';
    }
  </script>

</footer>

    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- MathJax -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
    $('body').scrollspy({
        target: '.bs-docs-sidebar',
        offset: 150 /* fixed header is about 40px high */
    });
    </script>
  </body>
</html>
